# x509 Auth and Keycloak

## Client Certificates
x509 Auth requires client certificates.

The script `./github/scripts/init-temp-keys.sh` has already generated a client certificate bundle for each user defined in the `sample.keycloak.yaml` file. You can find these in `/dsp-keys/`.

That same script has generated a **truststore** for Keycloak located at `/dsp-keys/local-dsp.virtru.com.truststore.jks`

These certs will be mounted into the Keycloak container at `/etc/x509/https/`


## System Trust

You will need to add your client certificates to your system (or browser) truststore.

On MacOs, you can add the certs to the system keychain with the following command:
```bash
	# Add PKCS12 file
  for f in $(ls dsp-keys/*.p12); do
	  security import "$f" -f pkcs12 -k "$HOME/Library/Keychains/login.keychain" -P 'password'
  done
```

The default password for all certs and truststores is `password`.

## Keycloak Configuration
### Docker Compose
In the file `compose/docker-compose.keycloak.yaml` uncomment the environment variables related to x509/PKI authentication:
- `KC_HTTPS_TRUST_STORE_FILE`
- `KC_HTTPS_TRUST_STORE_PASSWORD`

In the file `compose/docker-compose.keycloak.yaml` uncomment the volume mounts related to x509/PKI authentication:
- `../dsp-keys:/etc/x509/https/`
- `../dsp-keys/local-dsp.virtru.com.truststore.jks:/etc/x509/https/local-dsp.virtru.com.truststore.jks`

Restart the docker-compose stack to apply the changes:
- `docker-compose -f docker-compose.dev.yaml up`

### Keycloak Admin
Configure Keycloak for x509. This summary was generated from: https://www.keycloak.org/docs/latest/server_admin/#_browser_flow

1. Copy the existing browser flow
1. Add a step for `x509/Validate Username Form`
1. Move this step _above_ "browser forms"
1. From the action menu, click 'Bind Flow'
    - Bind the flow to the browser login

Then, configure the `x509` step:

> NOTE: the regular expression below does not render properly in a markdown preview

| Field    | Value |
| -------- | ------- |
| User Identity Source  | _Match SubjectDN using regular expression_ |
| Regular Expression | `emailAddress=(.*?)(?:,|$)` | 
| User Mapping Method    | _username or email_    |

Repeat the same steps for the direct access authorization flow if desired.
