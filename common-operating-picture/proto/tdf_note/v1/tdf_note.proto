syntax = "proto3";

package tdf_notes.v1;

import "google/protobuf/timestamp.proto";

option go_package = "github.com/virtru-corp/dsp-cop/api/proto/tdf_note/v1;tdf_notev1";

// The StreamEventType enum is reused from the previous schema
enum StreamEventType {
  STREAM_EVENT_TYPE_UNSPECIFIED = 0;

  // system events
  STREAM_EVENT_TYPE_STARTUP = 1;
  STREAM_EVENT_TYPE_SHUTDOWN = 2;
  STREAM_EVENT_TYPE_RESTART = 3;
  STREAM_EVENT_TYPE_MAINTENANCE = 4;

  // data events
  STREAM_EVENT_TYPE_CONNECTED = 5;
  STREAM_EVENT_TYPE_HEARTBEAT = 6;

  // generic events
  STREAM_EVENT_TYPE_GENERIC_ERROR = 10;
  STREAM_EVENT_TYPE_SERVER_ERROR = 11;
  STREAM_EVENT_TYPE_DATA_ERROR = 12;

  // tdf_notes stream events
  STREAM_EVENT_TYPE_TDF_NOTES_NEW = 20;
}

// Represents a note associated with a TDF object
message TdfNote {
  string id = 1; // Unique identifier for the note
  google.protobuf.Timestamp ts = 2; // Timestamp of the note creation
  string parent_id = 3; // Parent TDF object ID (foreign key to tdf_objects)
  string search = 4; // Plaintext JSON search index for searching notes
  bytes tdf_blob = 5; // Binary TDF data for the note
  string tdf_uri = 6; // URI pointing to the note data
  google.protobuf.Timestamp _created_at = 7; // Timestamp of when the note was created
  string _created_by = 8; // Who created the note
}

// Request message for creating a new note
message CreateTdfNoteRequest {
  string parent_id = 1; // Parent TDF object ID (foreign key to tdf_objects)
  string search = 2; // Plaintext JSON search index for searching notes
  bytes tdf_blob = 3; // Binary TDF data for the note
  string tdf_uri = 4; // URI pointing to the note data
  google.protobuf.Timestamp ts = 5; // Timestamp of the note
}

// Response message for creating a new note
message CreateTdfNoteResponse {
  string id = 1; // Unique identifier of the newly created note
}

// Request message to retrieve a note by ID
message GetTdfNoteRequest {
  string id = 1; // The ID of the note to retrieve
}

// Response message for retrieving a note by ID
message GetTdfNoteResponse {
  TdfNote tdf_note = 1; // The note object
}

// Request message for querying notes associated with a TDF object
message QueryTdfNotesRequest {
  string parent_id = 1; // Parent TDF object ID (foreign key to tdf_objects)
  google.protobuf.Timestamp start_ts = 2; // Start timestamp for querying notes
  google.protobuf.Timestamp end_ts = 3; // End timestamp for querying notes
  string search = 4; // Search query for filtering notes
}

// Response message for querying notes associated with a TDF object
message QueryTdfNotesResponse {
  repeated TdfNote tdf_notes = 1; // List of notes associated with the parent TDF object
}
message StreamTdfNotesRequest {
  // todo: intentionally left empty until we decide if any filtering needs to be done
}

// Stream response for streaming note events (similar to streaming TDF objects)
message StreamTdfNotesResponse {
  StreamEventType event_type = 1; // Type of stream event (e.g., new note)
  string event_detail = 2; // Details about the event
  reserved 3, 4, 5; // Reserved fields for future events

  repeated TdfNote tdf_notes = 6; // List of notes being streamed
}

// Service definition for handling TDF notes
service TdfNoteService {
  // RPC for creating a new TDF note
  rpc CreateTdfNote(CreateTdfNoteRequest) returns (CreateTdfNoteResponse);

  // RPC for retrieving a TDF note by ID
  rpc GetTdfNote(GetTdfNoteRequest) returns (GetTdfNoteResponse);

  // RPC for querying notes associated with a TDF object
  rpc QueryTdfNotes(QueryTdfNotesRequest) returns (QueryTdfNotesResponse);

  // RPC for streaming TDF notes (e.g., for real-time updates)
  rpc StreamTdfNotes(StreamTdfNotesRequest) returns (stream StreamTdfNotesResponse);
}
